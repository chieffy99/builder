<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Cards - Anti-Normalization (Updated)</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js" defer></script>
    <style>
        :root {
            --bg-primary: #050a18;
            --bg-secondary: #100117f9;
            --bg-third: rgba(255, 255, 255, 0.01);
            --bg-card: rgba(25, 30, 45, 0.85);
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent-primary: #6b8afd;
            --accent-secondary: #9c5fff;
            --status-0: #56ab2f;
            --status-1: #fdcb6e;
            --border-light: rgba(107, 138, 253, 0.3);
            --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --card-glow: 0 0 15px rgba(107, 138, 253, 0.2);
            --blur-effect: blur(10px);
            
            /* Z-index hierarchy */
            --z-background: -1;
            --z-workspace: 1;
            --z-card: 10;
            --z-card-active: 20;
            --z-navbar: 100;
            --z-fab: 1000;
            --z-fab-menu: 1010;
            --z-modal: 2000;
            --z-context-menu: 2010;
            --z-overlay: 3000;
        }
        
        body {
            font-family: 'Prompt', 'Sarabun', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Background effects */
        .background-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: var(--z-background);
            overflow: hidden;
            pointer-events: none;
        }
        
        .vertical-line {
            position: absolute;
            width: 1px;
            height: 100vh;
            background: linear-gradient(to bottom, transparent, rgba(107, 138, 253, 0.2), transparent);
            animation: float 15s infinite linear;
        }
        
        .dot {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: rgba(107, 138, 253, 0.5);
            animation: pulse 3s infinite ease-in-out;
        }
        
        @keyframes float {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }
        
        /* Navbar */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(16, 1, 23, 0.95);
            backdrop-filter: var(--blur-effect);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: var(--z-navbar);
            box-shadow: var(--card-shadow);
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            text-decoration: none;
        }
        
        .navbar-nav {
            margin-left: auto;
            display: flex;
            gap: 20px;
        }
        
        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            color: var(--text-primary);
            background: rgba(107, 138, 253, 0.1);
        }
        
        /* Main workspace */
        .dashboard-workspace {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: var(--z-workspace);
            overflow: hidden;
        }
        
        /* Card styles */
        .dashboard-card {
            position: absolute;
            min-width: 250px;
            min-height: 150px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            box-shadow: var(--card-shadow);
            backdrop-filter: var(--blur-effect);
            z-index: var(--z-card);
            transition: all 0.3s ease;
            cursor: move;
        }
        
        .dashboard-card:hover {
            box-shadow: 0 10px 40px rgba(107, 138, 253, 0.25);
        }
        
        .dashboard-card.card-dragging {
            opacity: 0.8;
            z-index: var(--z-card-active);
        }
        
        .dashboard-card.minimized .card-body {
            display: none;
        }
        
        .dashboard-card.minimized .card-io-indicators {
            display: none;
        }
        
        .dashboard-card.minimized {
            height: auto !important;
        }
        
        .card-header {
            background: linear-gradient(45deg, rgba(107, 138, 253, 0.4), rgba(156, 95, 255, 0.4));
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px 12px 0 0;
        }
        
        .card-title-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-type-indicator {
            font-size: 1.2rem;
            opacity: 0.8;
        }
        
        .card-title {
            margin: 0;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .card-tools {
            display: flex;
            gap: 8px;
        }
        
        .card-tool {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1rem;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .card-tool:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .card-body {
            padding: 15px;
            flex: 1;
            overflow: auto;
        }
        
        .card-placeholder {
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        
        .card-io-indicators {
            position: absolute;
            bottom: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
        }
        
        .input-indicator,
        .output-indicator {
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        .input-indicator {
            border: 2px solid var(--status-0);
        }
        
        .output-indicator {
            border: 2px solid var(--accent-primary);
        }
        
        /* Resize handle */
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: se-resize;
            background: linear-gradient(-45deg, transparent 30%, var(--border-light) 30%, var(--border-light) 40%, transparent 40%);
        }
        
        /* Chart container */
        .chart-container {
            width: 100%;
            height: 200px;
        }
        
        /* FAB */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: var(--z-fab);
        }
        
        .fab {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: var(--card-glow);
        }
        
        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            box-shadow: var(--card-shadow);
            backdrop-filter: var(--blur-effect);
            min-width: 200px;
            z-index: var(--z-fab-menu);
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .fab-menu.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        
        .fab-menu-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            background: none;
            border: none;
            color: var(--text-primary);
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .fab-menu-item:last-child {
            border-bottom: none;
        }
        
        .fab-menu-item:hover {
            background: rgba(107, 138, 253, 0.1);
        }
        
        /* Context menu */
        .context-menu {
            position: fixed;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-light);
            box-shadow: var(--card-shadow);
            backdrop-filter: var(--blur-effect);
            min-width: 150px;
            z-index: var(--z-context-menu);
            display: none;
        }
        
        .context-menu-item {
            display: block;
            width: 100%;
            padding: 10px 15px;
            background: none;
            border: none;
            color: var(--text-primary);
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        .context-menu-item:hover {
            background: rgba(107, 138, 253, 0.1);
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: var(--blur-effect);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
        }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            box-shadow: var(--card-shadow);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        /* Card type specific colors */
        .card-type-data {
            border-left: 4px solid var(--accent-primary);
        }
        
        .card-type-tool {
            border-left: 4px solid var(--accent-secondary);
        }
        
        .card-type-program {
            border-left: 4px solid var(--status-0);
        }
        
        /* Card mixing and connections */
        .card-connection {
            position: absolute;
            pointer-events: none;
            z-index: var(--z-card);
        }
        
        .card-connection-line {
            stroke: var(--accent-primary);
            stroke-width: 2;
            stroke-dasharray: 5,5;
            animation: dash 1s linear infinite;
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: -10;
            }
        }
        
        /* Card data validation indicators */
        .card-validation-indicator {
            position: absolute;
            top: 8px;
            right: 30px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        
        .card-validation-valid {
            background: var(--status-0);
            color: white;
        }
        
        .card-validation-invalid {
            background: #e74c3c;
            color: white;
        }
        
        .card-validation-warning {
            background: var(--status-1);
            color: #333;
        }
        
        /* Card hover effects for type distinction */
        .card-type-data:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px rgba(107, 138, 253, 0.3);
        }
        
        .card-type-tool:hover {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 20px rgba(156, 95, 255, 0.3);
        }
        
        .card-type-program:hover {
            border-color: var(--status-0);
            box-shadow: 0 0 20px rgba(86, 171, 47, 0.3);
        }
        
        /* Card mixing preview */
        .card-mix-preview {
            position: absolute;
            border: 2px dashed var(--accent-primary);
            background: rgba(107, 138, 253, 0.1);
            pointer-events: none;
            z-index: var(--z-card-active);
        }
        
        /* Enhanced tooltip system */
        .card-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: var(--z-overlay);
            pointer-events: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }
        
        .card-tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .card-tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .navbar {
                padding: 0 15px;
            }
            
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .fab-container {
                bottom: 20px;
                right: 20px;
            }
            
            .fab {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Background Effect -->
    <div class="background-effect">
        <!-- Dynamic lines and dots will be generated by JavaScript -->
    </div>

    <!-- Navbar -->
    <nav class="navbar">
        <a href="#" class="navbar-brand">Dashboard System</a>
        <div class="navbar-nav">
            <a href="#" class="nav-link">หน้าแรก</a>
            <a href="#" class="nav-link">การ์ด</a>
            <a href="#" class="nav-link">ตั้งค่า</a>
        </div>
    </nav>

    <!-- Main Workspace -->
    <div id="dashboardWorkspace" class="dashboard-workspace">
        <!-- Cards will be dynamically added here -->
    </div>

    <!-- Floating Action Button -->
    <div class="fab-container">
        <button id="fabMain" class="fab">+</button>
        <div id="fabMenu" class="fab-menu">
            <button class="fab-menu-item" onclick="dashboardManager.createCard('data', 100, 150)">📊 สร้างการ์ดข้อมูล</button>
            <button class="fab-menu-item" onclick="dashboardManager.createCard('tool', 150, 200)">🔧 สร้างการ์ดเครื่องมือ</button>
            <button class="fab-menu-item" onclick="dashboardManager.createCard('program', 200, 250)">⚙️ สร้างการ์ดโปรแกรม</button>
            <button class="fab-menu-item" onclick="dashboardManager.createSampleCard('line-chart', 100, 100)">📈 กราฟเส้น</button>
            <button class="fab-menu-item" onclick="dashboardManager.createSampleCard('bar-chart', 500, 100)">📊 กราฟแท่ง</button>
            <button class="fab-menu-item" onclick="dashboardManager.createSampleCard('pie-chart', 100, 400)">🥧 กราฟวงกลม</button>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <button class="context-menu-item" id="stackCard">ซ้อนการ์ด</button>
        <button class="context-menu-item" id="duplicateCard">ทำสำเนา</button>
        <button class="context-menu-item" id="deleteCard">ลบการ์ด</button>
    </div>

    <!-- Stack Modal -->
    <div id="stackModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ซ้อนการ์ด</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>เลือกการ์ดที่ต้องการซ้อน:</p>
                <div id="stackCardList">
                    <!-- Card list will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Background effects
        function createBackgroundEffect() {
            const bg = document.querySelector('.background-effect');
            
            // Create vertical lines
            for (let i = 0; i < 20; i++) {
                const line = document.createElement('div');
                line.className = 'vertical-line';
                line.style.left = `${Math.random() * 100}%`;
                line.style.animationDelay = `${Math.random() * 15}s`;
                bg.appendChild(line);
            }
            
            // Create dots
            for (let i = 0; i < 50; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                dot.style.left = `${Math.random() * 100}%`;
                dot.style.top = `${Math.random() * 100}%`;
                dot.style.animationDelay = `${Math.random() * 3}s`;
                bg.appendChild(dot);
            }
        }

        // FAB functionality
        document.getElementById('fabMain').addEventListener('click', function() {
            const menu = document.getElementById('fabMenu');
            menu.classList.toggle('show');
        });

        // Close FAB menu when clicking outside
        document.addEventListener('click', function(e) {
            const fabContainer = document.querySelector('.fab-container');
            const menu = document.getElementById('fabMenu');
            
            if (!fabContainer.contains(e.target)) {
                menu.classList.remove('show');
            }
        });

        // ESC key handler
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close FAB menu
                document.getElementById('fabMenu').classList.remove('show');
                
                // Close context menu
                dashboardManager.hideContextMenu();
                
                // Close modals
                document.getElementById('stackModal').style.display = 'none';
            }
        });

        // Dashboard Manager - Updated Card System
        const dashboardManager = {
            cards: [],
            nextId: 1,
            workspace: document.getElementById('dashboardWorkspace'),
            contextMenu: document.getElementById('contextMenu'),
            stackModal: document.getElementById('stackModal'),
            
            // Card Type Definitions
            cardTypes: {
                data: {
                    acceptsInput: true,
                    producesOutput: true,
                    canMix: true,
                    icon: '📊',
                    color: 'rgba(107, 138, 253, 0.4)',
                    cssClass: 'card-type-data'
                },
                tool: {
                    acceptsInput: true,
                    producesOutput: true,
                    canMix: false,
                    icon: '🔧',
                    color: 'rgba(156, 95, 255, 0.4)',
                    cssClass: 'card-type-tool'
                },
                program: {
                    acceptsInput: false,
                    producesOutput: false,
                    canMix: false,
                    icon: '⚙️',
                    color: 'rgba(86, 171, 47, 0.4)',
                    cssClass: 'card-type-program'
                }
            },

            // Create new card with type-specific properties
            createCard: function(type = 'data', x = 50, y = 50, width = 300, height = 200, title = 'New Card', content = '') {
                const cardId = this.nextId++;
                const cardTypeConfig = this.cardTypes[type] || this.cardTypes.data;
                
                const card = {
                    id: cardId,
                    type: type,
                    title: title,
                    content: content,
                    x: x,
                    y: y,
                    width: width,
                    height: height,
                    locked: false,
                    minimized: false,
                    backgroundColor: cardTypeConfig.color,
                    fontSize: '14px',
                    fontColor: '#333',
                    borderRadius: '8px',
                    metadata: {
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        version: '1.0',
                        typeConfig: cardTypeConfig
                    },
                    // Data I/O properties
                    inputs: [],
                    outputs: [],
                    connections: [],
                    data: {},
                    element: null
                };
                
                const cardElement = this.createCardElement(card);
                card.element = cardElement;
                this.cards.push(card);
                this.workspace.appendChild(cardElement);
                
                // Type-specific initialization
                this.initializeCardType(card);
                
                return card;
            },

            // Type-specific initialization
            initializeCardType: function(card) {
                const typeConfig = this.cardTypes[card.type];
                
                // Add type indicator to card
                const typeIndicator = card.element.querySelector('.card-type-indicator');
                if (typeIndicator) {
                    typeIndicator.textContent = typeConfig.icon;
                    typeIndicator.title = `Card Type: ${card.type}`;
                }
                
                // Add CSS class for type-specific styling
                card.element.classList.add(typeConfig.cssClass);
                
                // Initialize type-specific behaviors
                switch(card.type) {
                    case 'data':
                        this.initializeDataCard(card);
                        break;
                    case 'tool':
                        this.initializeToolCard(card);
                        break;
                    case 'program':
                        this.initializeProgramCard(card);
                        break;
                }
            },

            // Data card initialization
            initializeDataCard: function(card) {
                // Data cards can accept and produce data
                card.inputs = ['data-input'];
                card.outputs = ['data-output'];
                
                // Add data management capabilities
                if (!card.data) card.data = {};
                
                // Enable mixing capabilities
                this.enableCardMixing(card);
            },

            // Tool card initialization  
            initializeToolCard: function(card) {
                // Tool cards process input and produce output
                card.inputs = ['tool-input'];
                card.outputs = ['tool-output'];
                
                // Tools cannot be mixed with other cards
                // Add tool-specific functionality here
            },

            // Program card initialization
            initializeProgramCard: function(card) {
                // Program cards are standalone
                card.inputs = [];
                card.outputs = [];
                
                // Add program execution capabilities
            },

            // Enable card mixing (for data cards only)
            enableCardMixing: function(card) {
                if (card.type !== 'data') return;
                
                // Add mixing capabilities
                card.mixable = true;
                card.mixedCards = [];
            },

            // Create card DOM element
            createCardElement: function(card) {
                const cardElement = document.createElement('div');
                cardElement.className = 'dashboard-card';
                cardElement.id = `card-${card.id}`;
                cardElement.style.left = `${card.x}px`;
                cardElement.style.top = `${card.y}px`;
                cardElement.style.width = `${card.width}px`;
                cardElement.style.height = `${card.height}px`;
                
                const typeConfig = this.cardTypes[card.type];
                
                cardElement.innerHTML = `
                    <div class="card-header">
                        <div class="card-title-container">
                            <span class="card-type-indicator" title="Card Type: ${card.type}">${typeConfig.icon}</span>
                            <h3 class="card-title">${card.title}</h3>
                        </div>
                        <div class="card-tools">
                            ${card.type === 'data' ? '<button class="card-tool card-tool-stack" title="ซ้อนกราฟ">⊕</button>' : ''}
                            <button class="card-tool card-tool-settings" title="ตั้งค่า">⚙️</button>
                            <button class="card-tool card-tool-minimize" title="ย่อ/ขยาย">−</button>
                            <button class="card-tool card-tool-close" title="ปิด">×</button>
                        </div>
                    </div>
                    <div class="card-body">
                        ${card.content || '<div class="card-placeholder">เนื้อหาการ์ดจะแสดงที่นี่</div>'}
                    </div>
                    <div class="card-io-indicators" style="${typeConfig.acceptsInput || typeConfig.producesOutput ? '' : 'display: none;'}">
                        ${typeConfig.acceptsInput ? '<div class="input-indicator" title="Accepts Input">📥</div>' : ''}
                        ${typeConfig.producesOutput ? '<div class="output-indicator" title="Produces Output">📤</div>' : ''}
                    </div>
                    <div class="resize-handle"></div>
                `;
                
                // Add event handlers
                this.addCardEventHandlers(cardElement, card.id);
                this.makeDraggable(cardElement);
                this.makeResizable(cardElement);
                
                return cardElement;
            },

            // Legacy support: Create sample cards (updated to use new card system)
            createSampleCard: function(type, x, y) {
                let cardType, title, content;
                
                switch (type) {
                    case 'line-chart':
                    case 'bar-chart':
                    case 'pie-chart':
                        cardType = 'data';
                        title = type === 'line-chart' ? 'กราฟเส้น' : 
                               type === 'bar-chart' ? 'กราฟแท่ง' : 'กราฟวงกลม';
                        content = `<canvas id="chart-card-${this.nextId}" class="chart-container"></canvas>`;
                        break;
                    case 'table':
                        cardType = 'data';
                        title = 'ตารางข้อมูล';
                        content = '<div class="table-container"><p>ตารางข้อมูลจะแสดงที่นี่</p></div>';
                        break;
                    case 'summary':
                        cardType = 'data';
                        title = 'สรุปข้อมูล';
                        content = '<div class="summary-container"><p>ข้อมูลสรุปจะแสดงที่นี่</p></div>';
                        break;
                    case 'custom':
                        cardType = 'tool';
                        title = 'การ์ดกำหนดเอง';
                        content = '<div class="custom-container"><p>เนื้อหากำหนดเองจะแสดงที่นี่</p></div>';
                        break;
                    default:
                        cardType = 'data';
                        title = 'การ์ดใหม่';
                        content = '<div class="default-container"><p>เนื้อหาจะแสดงที่นี่</p></div>';
                }
                
                const card = this.createCard(cardType, x, y, 300, 200, title, content);
                
                // สร้างกราฟถ้าเป็นการ์ดกราฟ
                if (type.includes('chart')) {
                    const chartType = type.replace('-chart', '');
                    card.chartType = chartType;
                    this.createSampleChart(card.id, chartType);
                }
                
                return card;
            },

            // Make card draggable
            makeDraggable: function(card) {
                let isDragging = false;
                let startX, startY, startLeft, startTop;
                
                const header = card.querySelector('.card-header');
                
                header.addEventListener('mousedown', (e) => {
                    // Skip if clicking on tools
                    if (e.target.closest('.card-tool')) {
                        return;
                    }
                    
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startLeft = parseInt(card.style.left) || 0;
                    startTop = parseInt(card.style.top) || 0;
                    
                    card.classList.add('card-dragging');
                    card.style.zIndex = 100;
                    
                    const dragMove = (e) => {
                        if (!isDragging) return;
                        
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;
                        
                        card.style.left = `${startLeft + dx}px`;
                        card.style.top = `${startTop + dy}px`;
                    };
                    
                    const dragEnd = () => {
                        isDragging = false;
                        card.classList.remove('card-dragging');
                        card.style.zIndex = '';
                        
                        document.removeEventListener('mousemove', dragMove);
                        document.removeEventListener('mouseup', dragEnd);
                    };
                    
                    document.addEventListener('mousemove', dragMove);
                    document.addEventListener('mouseup', dragEnd);
                    
                    e.preventDefault();
                });
            },

            // Make card resizable
            makeResizable: function(card) {
                const resizeHandle = card.querySelector('.resize-handle');
                let isResizing = false;
                let startX, startY, startWidth, startHeight;
                
                resizeHandle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = parseInt(document.defaultView.getComputedStyle(card).width, 10);
                    startHeight = parseInt(document.defaultView.getComputedStyle(card).height, 10);
                    
                    const resizeMove = (e) => {
                        if (!isResizing) return;
                        
                        const newWidth = startWidth + e.clientX - startX;
                        const newHeight = startHeight + e.clientY - startY;
                        
                        card.style.width = `${Math.max(250, newWidth)}px`;
                        card.style.height = `${Math.max(150, newHeight)}px`;
                    };
                    
                    const resizeEnd = () => {
                        isResizing = false;
                        document.removeEventListener('mousemove', resizeMove);
                        document.removeEventListener('mouseup', resizeEnd);
                    };
                    
                    document.addEventListener('mousemove', resizeMove);
                    document.addEventListener('mouseup', resizeEnd);
                    
                    e.preventDefault();
                    e.stopPropagation();
                });
            },

            // Add card event handlers
            addCardEventHandlers: function(cardElement, cardId) {
                // Close button
                const closeBtn = cardElement.querySelector('.card-tool-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        this.removeCard(cardId);
                    });
                }
                
                // Minimize button
                const minimizeBtn = cardElement.querySelector('.card-tool-minimize');
                if (minimizeBtn) {
                    minimizeBtn.addEventListener('click', () => {
                        cardElement.classList.toggle('minimized');
                        minimizeBtn.textContent = cardElement.classList.contains('minimized') ? '+' : '−';
                    });
                }
                
                // Settings button
                const settingsBtn = cardElement.querySelector('.card-tool-settings');
                if (settingsBtn) {
                    settingsBtn.addEventListener('click', () => {
                        // Open card settings (to be implemented)
                        console.log(`Opening settings for card ${cardId}`);
                    });
                }
                
                // Stack button (data cards only)
                const stackBtn = cardElement.querySelector('.card-tool-stack');
                if (stackBtn) {
                    stackBtn.addEventListener('click', () => {
                        this.openStackModal(cardId);
                    });
                }
                
                // Context menu
                cardElement.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showContextMenu(e.clientX, e.clientY, cardId);
                });
            },

            // Create sample chart
            createSampleChart: function(cardId, chartType) {
                setTimeout(() => {
                    const canvas = document.getElementById(`chart-card-${cardId}`);
                    if (canvas && window.Chart) {
                        const ctx = canvas.getContext('2d');
                        
                        let chartConfig = {
                            type: chartType,
                            data: {
                                labels: ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน'],
                                datasets: [{
                                    label: 'ข้อมูลตัวอย่าง',
                                    data: [12, 19, 3, 5, 2, 3],
                                    backgroundColor: [
                                        'rgba(107, 138, 253, 0.6)',
                                        'rgba(156, 95, 255, 0.6)',
                                        'rgba(86, 171, 47, 0.6)',
                                        'rgba(253, 203, 110, 0.6)',
                                        'rgba(255, 99, 132, 0.6)',
                                        'rgba(54, 162, 235, 0.6)'
                                    ],
                                    borderColor: [
                                        'rgba(107, 138, 253, 1)',
                                        'rgba(156, 95, 255, 1)',
                                        'rgba(86, 171, 47, 1)',
                                        'rgba(253, 203, 110, 1)',
                                        'rgba(255, 99, 132, 1)',
                                        'rgba(54, 162, 235, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        labels: {
                                            color: '#e0e0e0'
                                        }
                                    }
                                },
                                scales: chartType !== 'pie' ? {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            color: '#a0a0a0'
                                        },
                                        grid: {
                                            color: 'rgba(255, 255, 255, 0.1)'
                                        }
                                    },
                                    x: {
                                        ticks: {
                                            color: '#a0a0a0'
                                        },
                                        grid: {
                                            color: 'rgba(255, 255, 255, 0.1)'
                                        }
                                    }
                                } : {}
                            }
                        };
                        
                        new Chart(ctx, chartConfig);
                    }
                }, 100);
            },

            // Show context menu
            showContextMenu: function(x, y, cardId) {
                this.contextMenu.style.left = `${x}px`;
                this.contextMenu.style.top = `${y}px`;
                this.contextMenu.style.display = 'block';
                this.contextMenu.dataset.cardId = cardId;
                
                document.addEventListener('click', this.hideContextMenu.bind(this));
            },

            // Hide context menu
            hideContextMenu: function() {
                this.contextMenu.style.display = 'none';
                document.removeEventListener('click', this.hideContextMenu);
            },

            // Open stack modal
            openStackModal: function(cardId) {
                const modal = this.stackModal;
                const cardList = modal.querySelector('#stackCardList');
                
                // Clear existing list
                cardList.innerHTML = '';
                
                // Add available cards for stacking
                this.cards.forEach(card => {
                    if (card.id !== cardId && card.type === 'data') {
                        const item = document.createElement('button');
                        item.className = 'fab-menu-item';
                        item.textContent = card.title;
                        item.onclick = () => {
                            this.stackCards(cardId, card.id);
                            modal.style.display = 'none';
                        };
                        cardList.appendChild(item);
                    }
                });
                
                modal.style.display = 'flex';
                
                // Close modal handlers
                modal.querySelector('.modal-close').onclick = () => {
                    modal.style.display = 'none';
                };
                
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                };
            },

            // Stack cards (placeholder implementation)
            stackCards: function(cardId1, cardId2) {
                console.log(`Stacking cards ${cardId1} and ${cardId2}`);
                // Implement card stacking logic here
            },

            // Remove card
            removeCard: function(cardId) {
                const cardIndex = this.cards.findIndex(card => card.id === cardId);
                if (cardIndex !== -1) {
                    const card = this.cards[cardIndex];
                    if (card.element) {
                        card.element.remove();
                    }
                    this.cards.splice(cardIndex, 1);
                }
            },

            // Get card by ID
            getCard: function(cardId) {
                return this.cards.find(card => card.id === cardId);
            },

            // Update card data
            updateCardData: function(cardId, data) {
                const card = this.getCard(cardId);
                if (card) {
                    card.data = { ...card.data, ...data };
                    card.metadata.modified = new Date().toISOString();
                }
            },

            // Validate card input/output
            validateCardIO: function(card, inputData) {
                const typeConfig = this.cardTypes[card.type];
                
                if (!typeConfig.acceptsInput && inputData) {
                    console.warn(`Card ${card.id} does not accept input`);
                    return false;
                }
                
                // Add more validation logic here
                return true;
            }
        };

        // Context menu event handlers
        document.getElementById('stackCard').addEventListener('click', function() {
            const cardId = dashboardManager.contextMenu.dataset.cardId;
            if (cardId) {
                dashboardManager.openStackModal(parseInt(cardId));
            }
            dashboardManager.hideContextMenu();
        });

        document.getElementById('duplicateCard').addEventListener('click', function() {
            const cardId = dashboardManager.contextMenu.dataset.cardId;
            if (cardId) {
                const originalCard = dashboardManager.getCard(parseInt(cardId));
                if (originalCard) {
                    dashboardManager.createCard(
                        originalCard.type,
                        originalCard.x + 20,
                        originalCard.y + 20,
                        originalCard.width,
                        originalCard.height,
                        originalCard.title + ' (Copy)',
                        originalCard.content
                    );
                }
            }
            dashboardManager.hideContextMenu();
        });

        document.getElementById('deleteCard').addEventListener('click', function() {
            const cardId = dashboardManager.contextMenu.dataset.cardId;
            if (cardId) {
                dashboardManager.removeCard(parseInt(cardId));
            }
            dashboardManager.hideContextMenu();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            createBackgroundEffect();
            
            // Create some initial cards
            dashboardManager.createSampleCard('line-chart', 100, 100);
            dashboardManager.createSampleCard('bar-chart', 500, 100);
            dashboardManager.createSampleCard('pie-chart', 100, 400);
        });

        // Make dashboardManager accessible from console (for testing)
        window.dashboardManager = dashboardManager;
    </script>
</body>
</html>
